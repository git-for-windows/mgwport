#!/bin/bash

set -e

rm -f ${PACKAGE}-${VERSION}-1-src.tar.bz2 ${PACKAGE}-${VERSION}-1.tar.bz2

if [ -f ${top_srcdir}/../${PACKAGE}-${VERSION}.tar.xz ]
then
	# running under make distcheck
	# make dist during make distcheck won't work because all files in
	# DISTDIR are read-only
	cp -f ${top_srcdir}/../${PACKAGE}-${VERSION}.tar.xz .
else
	${MAKE} -C ${top_builddir} dist-xz > /dev/null
	cp -f ${top_builddir}/${PACKAGE}-${VERSION}.tar.xz .
fi

cp -f ${top_srcdir}/data/sample.mgwport ${PACKAGE}-${VERSION}-1.mgwport

${top_builddir}/bin/mgwport-inplace ${PACKAGE}-${VERSION}-1.mgwport prep compile install pkg

cp -r ${PACKAGE}-${VERSION}-1/dist/${PACKAGE} .

${top_builddir}/bin/mgwport-inplace ${PACKAGE}-${VERSION}-1.mgwport finish

rm -f ${PACKAGE}-${VERSION}-1-src.tar.bz2 ${PACKAGE}-${VERSION}-1.tar.bz2
rm -f ${PACKAGE}-${VERSION}.tar.xz ${PACKAGE}-${VERSION}-1.mgwport
